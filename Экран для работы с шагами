package com.example.sj

import android.content.Intent
import android.os.Bundle
import android.widget.EditText
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.floatingactionbutton.FloatingActionButton
import android.graphics.Color

class StepsActivity : AppCompatActivity() {

    private lateinit var stepsAdapter: StepsAdapter
    private val stepsList = mutableListOf<DreamStep>()
    private var currentDreamId: Long = 0
    private var dreamTitle: String = ""

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_steps)

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
        currentDreamId = intent.getLongExtra("dream_id", 0L)
        dreamTitle = intent.getStringExtra("dream_title") ?: "–ú–æ—è –º–µ—á—Ç–∞"

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏
        loadSavedSteps()

        setupUI()
        setupRecyclerView()
    }

    private fun loadSavedSteps() {
        stepsList.clear()
        val savedSteps = DreamManager.getDreamSteps(currentDreamId)

        if (savedSteps.isNotEmpty()) {
            stepsList.addAll(savedSteps)
        }
    }

    private fun setupUI() {
        val tvDreamTitle = findViewById<TextView>(R.id.tv_dream_title)
        tvDreamTitle.text = "–®–∞–≥–∏: $dreamTitle"

        findViewById<ImageView>(R.id.iv_back).setOnClickListener {
            saveStepsBeforeExit()
            finish()
        }

        findViewById<FloatingActionButton>(R.id.fab_add_step).setOnClickListener {
            showAddStepDialog()
        }

        // –ï—Å–ª–∏ —à–∞–≥–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        if (stepsList.isEmpty()) {
            Toast.makeText(this, "–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥", Toast.LENGTH_SHORT).show()
        }
    }

    private fun setupRecyclerView() {
        stepsAdapter = StepsAdapter(stepsList)

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —à–∞–≥–∞
        stepsAdapter.onStepChecked = { step, isChecked, position ->
            step.completed = isChecked
            DreamManager.updateStepCompletion(currentDreamId, position, isChecked)
            checkAllStepsCompleted()
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —à–∞–≥–∞
        stepsAdapter.onStepDelete = { position ->
            if (stepsList.size > 1) {
                stepsList.removeAt(position)
                DreamManager.updateDreamSteps(currentDreamId, stepsList)
                stepsAdapter.updateSteps(stepsList)
                checkAllStepsCompleted()
            } else {
                Toast.makeText(this, "–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–≥", Toast.LENGTH_SHORT).show()
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —à–∞–≥–∞
        stepsAdapter.onStepTextChanged = { position, newText ->
            stepsList[position].text = newText
            DreamManager.updateDreamSteps(currentDreamId, stepsList)
        }

        val recyclerView = findViewById<RecyclerView>(R.id.rv_steps)
        recyclerView.layoutManager = LinearLayoutManager(this)
        recyclerView.adapter = stepsAdapter
    }

    private fun checkAllStepsCompleted(): Boolean {
        if (stepsList.isEmpty()) return false

        val allCompleted = stepsList.all { it.completed }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ DreamManager
        DreamManager.updateDreamSteps(currentDreamId, stepsList)

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        updateMainActivityStar(allCompleted)

        if (allCompleted) {
            Toast.makeText(this, "üéâ –í—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! –ú–µ—á—Ç–∞ —Å–±—ã–≤–∞–µ—Ç—Å—è!", Toast.LENGTH_LONG).show()
        }

        return allCompleted
    }

    private fun updateMainActivityStar(allStepsCompleted: Boolean) {
        val resultIntent = Intent().apply {
            putExtra("dream_id", currentDreamId)
            putExtra("all_steps_completed", allStepsCompleted)
        }
        setResult(RESULT_OK, resultIntent)
    }

    private fun showAddStepDialog() {
        val dialogBuilder = AlertDialog.Builder(this)
        val dialogView = layoutInflater.inflate(R.layout.dialog_simple_input, null)
        val editText = dialogView.findViewById<EditText>(R.id.et_input)

        editText.setText("")
        editText.hint = "–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"
        editText.setTextColor(Color.BLACK)

        val dialog = dialogBuilder.setView(dialogView)
            .setTitle("–î–æ–±–∞–≤–∏—Ç—å —à–∞–≥")
            .setPositiveButton("–î–æ–±–∞–≤–∏—Ç—å") { _, _ ->
                val stepText = editText.text.toString().trim()
                if (stepText.isNotEmpty()) {
                    val newStep = DreamStep(stepText, false)
                    stepsList.add(newStep)
                    DreamManager.updateDreamSteps(currentDreamId, stepsList)
                    stepsAdapter.updateSteps(stepsList)
                    checkAllStepsCompleted()
                }
            }
            .setNegativeButton("–û—Ç–º–µ–Ω–∞", null)
            .create()

        dialog.show()
    }

    private fun saveStepsBeforeExit() {
        DreamManager.updateDreamSteps(currentDreamId, stepsList)
        checkAllStepsCompleted()
    }

    override fun onBackPressed() {
        saveStepsBeforeExit()
        super.onBackPressed()
    }

    override fun onPause() {
        super.onPause()
        saveStepsBeforeExit()
    }
}
